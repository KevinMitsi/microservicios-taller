pipeline {
    agent any

    tools {
        maven 'Maven'
    }

    environment {
        // AsegÃºrate de tener la credencial "sonar_token" en Jenkins (Secret Text)
        SONAR_TOKEN = credentials('sonarqube-token')
        // Nombre del servidor SonarQube configurado en Manage Jenkins -> SonarQube servers
        SONARQUBE_ENV = 'SonarQube'
        SONAR_PROJECT_KEY = 'msvc-security'
        SONAR_PROJECT_NAME = 'MSVC Security'
        MAVEN_OPTS = '-Xmx1024m'
        JAVA_HOME = '/opt/java/openjdk'
        PATH = "${JAVA_HOME}/bin:${env.PATH}"
    }

    stages {

        stage('Checkout') {
            steps {
                echo 'ğŸ”„ Clonando repositorio...'
                checkout scm
                echo 'âœ… Repositorio clonado exitosamente'
            }
        }

        stage('Clean') {
            steps {
                dir('msvc-security') {
                    echo 'ğŸ§¹ Limpiando workspace...'
                    sh 'mvn clean'
                    echo 'âœ… Workspace limpio'
                }
            }
        }

        stage('Build') {
            steps {
                dir('msvc-security') {
                    echo 'ğŸ”¨ Compilando proyecto...'
                    sh 'mvn compile -DskipTests'
                    echo 'âœ… Proyecto compilado exitosamente'
                }
            }
        }

        stage('Unit & Integration Tests') {
            steps {
                dir('msvc-security') {
                    echo 'ğŸ§ª Ejecutando pruebas unitarias e integraciÃ³n...'
                    sh 'mvn test'
                    echo 'âœ… Pruebas completadas'
                }
            }
            post {
                always {
                    dir('msvc-security') {
                        junit allowEmptyResults: true, testResults: '**/target/surefire-reports/*.xml'
                    }
                }
            }
        }

        stage('Code Coverage') {
            steps {
                dir('msvc-security') {
                    echo 'ğŸ“Š Generando reporte de cobertura con JaCoCo...'
                    sh 'mvn jacoco:report'
                    echo 'âœ… Reporte de cobertura generado'
                }
            }
            post {
                always {
                    dir('msvc-security') {
                        jacoco(
                            execPattern: '**/target/jacoco.exec',
                            classPattern: '**/target/classes',
                            sourcePattern: '**/src/main/java',
                            exclusionPattern: '**/*Test*.class,**/*Config*.class,**/*Application*.class'
                        )
                    }
                }
            }
        }

        stage('Cucumber Reports') {
            steps {
                dir('msvc-security') {
                    echo 'ğŸ¥’ Generando reportes de Cucumber...'
                    sh 'mvn verify -DskipUnitTests=false'
                    echo 'âœ… Reportes de Cucumber generados'
                }
            }
            post {
                always {
                    dir('msvc-security') {
                        cucumber buildStatus: 'UNSTABLE',
                            reportTitle: 'Cucumber BDD Test Report',
                            fileIncludePattern: '**/cucumber-reports/*.json',
                            trendsLimit: 10,
                            classifications: [
                                [key: 'Microservicio', value: 'Security'],
                                [key: 'Ambiente', value: 'CI/CD'],
                                [key: 'Framework', value: 'Cucumber + Spring Boot']
                            ]
                    }
                }
            }
        }

        stage('Publish Reports') {
            steps {
                dir('msvc-security') {
                    echo 'ğŸ“ˆ Publicando reportes en Jenkins...'

                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'target/site/jacoco',
                        reportFiles: 'index.html',
                        reportName: 'JaCoCo Coverage Report',
                        reportTitles: 'Code Coverage'
                    ])

                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'target/cucumber-html-reports',
                        reportFiles: 'overview-features.html',
                        reportName: 'Cucumber HTML Report',
                        reportTitles: 'BDD Test Results'
                    ])

                    echo 'âœ… Reportes publicados exitosamente'
                }
            }
        }

        // ğŸ” SonarQube al final (tolerante a fallos)
        stage('SonarQube Analysis') {
            steps {
                dir('msvc-security') {
                    echo 'ğŸ” Iniciando anÃ¡lisis de calidad con SonarQube...'
                    catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                        // withSonarQubeEnv inyecta la configuraciÃ³n del servidor Sonar (URL / token) tal como estÃ©
                        // configurado en Jenkins (Manage Jenkins -> SonarQube servers)
                        withSonarQubeEnv("${env.SONARQUBE_ENV}") {
                            sh """
                                mvn sonar:sonar \
                                  -Dsonar.projectKey=${env.SONAR_PROJECT_KEY} \
                                  -Dsonar.projectName="${env.SONAR_PROJECT_NAME}" \
                                  -Dsonar.java.binaries=target/classes \
                                  -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
                                  -Dsonar.junit.reportPaths=target/surefire-reports
                            """
                        }
                    }
                    echo 'âœ… AnÃ¡lisis de SonarQube completado (o marcado como inestable si fallÃ³)'
                }
            }
        }

        stage('Report Results') {
            steps {
                script {
                    echo 'ğŸ“‹ ======================================'
                    echo 'ğŸ“‹ RESUMEN DE EJECUCIÃ“N DEL PIPELINE'
                    echo 'ğŸ“‹ ======================================'
                    echo "ğŸ“¦ Proyecto: ${env.JOB_NAME}"
                    echo "ğŸ”¢ Build: #${env.BUILD_NUMBER}"
                    echo "ğŸŒ¿ Rama: ${env.GIT_BRANCH}"
                    // Si withSonarQubeEnv inyectÃ³ SONAR_HOST_URL estarÃ¡ disponible en env, si no, cae al fallback
                    echo "ğŸ”— SonarQube: ${env.SONAR_HOST_URL ?: 'http://sonarqube:9000'}/dashboard?id=${env.SONAR_PROJECT_KEY}"
                    echo 'ğŸ“‹ ======================================'
                    echo 'âœ… Pipeline completado'
                    echo 'ğŸ“‹ ======================================'
                }
            }
        }
    }

    post {
        success {
            echo 'âœ… Â¡BUILD EXITOSO! ğŸ‰'
        }
        failure {
            echo 'âŒ BUILD FALLIDO'
            // Uso seguro de env.* y fallback para evitar MissingPropertyException
            echo "ğŸ”— Revisa SonarQube: ${env.SONAR_HOST_URL ?: 'http://sonarqube:9000'}/dashboard?id=${env.SONAR_PROJECT_KEY ?: 'msvc-security'}"
        }
        unstable {
            echo 'âš ï¸ BUILD INESTABLE'
        }
        always {
            echo 'ğŸ§¹ Pipeline finalizado'
        }
    }
}
