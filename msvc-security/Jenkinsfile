pipeline {
    agent any

    tools {
        maven 'Maven'
        jdk 'JDK-21'
    }

    environment {
        DOCKER_IMAGE = 'kevinmitsi/msvc-security'
        DOCKER_CREDENTIALS = credentials('dockerhub-credentials')
        SONAR_TOKEN = credentials('sonarqube-token')
        MICROSERVICE_DIR = 'msvc-security'
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'ğŸ“¥ Clonando repositorio del proyecto...'
                checkout scm
                script {
                    // Mostrar informaciÃ³n del commit
                    sh 'git log -1 --pretty=format:"%h - %an, %ar : %s"'
                    sh "echo 'Branch: ${env.GIT_BRANCH}'"
                }
            }
        }

        stage('Build') {
            steps {
                echo 'ğŸ”¨ Compilando proyecto...'
                dir("${MICROSERVICE_DIR}") {
                    sh 'mvn clean compile'
                }
            }
        }

        stage('Unit & Integration Tests') {
            steps {
                echo 'ğŸ§ª Ejecutando pruebas unitarias y de integraciÃ³n (Cucumber)...'
                dir("${MICROSERVICE_DIR}") {
                    sh 'mvn test'
                    sh 'mvn verify'
                }
            }
            post {
                always {
                    // Publicar resultados de JUnit
                    junit allowEmptyResults: true, testResults: '**/target/surefire-reports/*.xml'

                    // Publicar cobertura de cÃ³digo con JaCoCo
                    jacoco(
                        execPattern: '**/target/jacoco.exec',
                        classPattern: '**/target/classes',
                        sourcePattern: '**/src/main/java',
                        exclusionPattern: '**/config/**,**/dto/**,**/entity/**,**/model/**'
                    )

                    // Publicar reportes de Cucumber
                    cucumber buildStatus: 'UNSTABLE',
                        reportTitle: 'Cucumber BDD Test Report',
                        fileIncludePattern: '**/cucumber-reports/*.json',
                        trendsLimit: 10,
                        classifications: [
                            [key: 'Browser', value: 'REST API'],
                            [key: 'Environment', value: 'Test'],
                            [key: 'Microservice', value: 'msvc-security']
                        ]

                    // Publicar reportes HTML de Cucumber
                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: "${MICROSERVICE_DIR}/target/cucumber-report-html",
                        reportFiles: 'overview-features.html',
                        reportName: 'Cucumber HTML Report',
                        reportTitles: 'Cucumber Test Results'
                    ])
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                echo 'ğŸ“Š Analizando calidad de cÃ³digo con SonarQube...'
                dir("${MICROSERVICE_DIR}") {
                    withSonarQubeEnv('SonarQube') {
                        sh '''
                            mvn sonar:sonar \
                            -Dsonar.projectKey=msvc-security \
                            -Dsonar.projectName="MSvc Security" \
                            -Dsonar.host.url=http://sonarqube:9000 \
                            -Dsonar.login=$SONAR_TOKEN \
                            -Dsonar.java.binaries=target/classes \
                            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
                            -Dsonar.junit.reportPaths=target/surefire-reports \
                            -Dsonar.exclusions=**/config/**,**/dto/**,**/entity/**,**/model/**
                        '''
                    }
                }
            }
        }

        stage('Quality Gate') {
            steps {
                echo 'ğŸš¦ Verificando Quality Gate de SonarQube...'
                timeout(time: 5, unit: 'MINUTES') {
                    script {
                        def qg = waitForQualityGate()
                        if (qg.status != 'OK') {
                            error "Pipeline abortado debido a fallo en Quality Gate: ${qg.status}"
                        }
                        echo "âœ… Quality Gate pasado exitosamente"
                    }
                }
            }
        }

        stage('Package') {
            steps {
                echo 'ğŸ“¦ Empaquetando aplicaciÃ³n...'
                dir("${MICROSERVICE_DIR}") {
                    sh 'mvn package -DskipTests'
                    archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                echo 'ğŸ³ Construyendo imagen Docker...'
                dir("${MICROSERVICE_DIR}") {
                    script {
                        dockerImage = docker.build("${DOCKER_IMAGE}:${BUILD_NUMBER}")
                        docker.build("${DOCKER_IMAGE}:latest")
                    }
                }
            }
        }

        stage('Push to Docker Hub') {
            when {
                branch 'main'
            }
            steps {
                echo 'ğŸš€ Publicando imagen en Docker Hub...'
                script {
                    docker.withRegistry('https://registry.hub.docker.com', 'dockerhub-credentials') {
                        dockerImage.push("${BUILD_NUMBER}")
                        dockerImage.push("latest")
                    }
                }
            }
        }

        stage('Deploy to Development') {
            when {
                branch 'develop'
            }
            steps {
                echo 'ğŸŒ Desplegando en ambiente de desarrollo...'
                sh '''
                    docker-compose -f docker-compose.yml stop msvc-security
                    docker-compose -f docker-compose.yml rm -f msvc-security
                    docker-compose -f docker-compose.yml up -d msvc-security
                '''
            }
        }

        stage('Generate Test Report Summary') {
            steps {
                echo 'ğŸ“‹ Generando resumen de reportes...'
                script {
                    def testResults = junit '**/target/surefire-reports/*.xml'
                    def summary = """
                    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                    â•‘         RESUMEN DE EJECUCIÃ“N - MSVC SECURITY          â•‘
                    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
                    â•‘ Build: #${BUILD_NUMBER}
                    â•‘ Branch: ${env.GIT_BRANCH}
                    â•‘ Tests Totales: ${testResults.totalCount}
                    â•‘ Tests Exitosos: ${testResults.passCount}
                    â•‘ Tests Fallidos: ${testResults.failCount}
                    â•‘ Tests Omitidos: ${testResults.skipCount}
                    â•‘
                    â•‘ ğŸ“Š Reportes disponibles:
                    â•‘ - JUnit Test Results
                    â•‘ - JaCoCo Coverage Report
                    â•‘ - Cucumber BDD Report
                    â•‘ - SonarQube Quality Analysis
                    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    """
                    echo summary
                }
            }
        }
    }

    post {
        always {
            echo 'ğŸ§¹ Limpiando workspace...'
            // Archivar reportes antes de limpiar
            archiveArtifacts artifacts: '**/target/cucumber-reports/**/*.*', allowEmptyArchive: true
            archiveArtifacts artifacts: '**/target/cucumber-report-html/**/*.*', allowEmptyArchive: true
            archiveArtifacts artifacts: '**/target/site/jacoco/**/*.*', allowEmptyArchive: true
        }
        success {
            echo 'âœ… Â¡Pipeline ejecutado exitosamente!'
            echo 'ğŸ“Š Todos los reportes estÃ¡n disponibles en la pÃ¡gina del build'
            echo 'ğŸ” Revisa SonarQube para anÃ¡lisis detallado de calidad'
            // AquÃ­ podrÃ­as enviar notificaciones (Slack, email, etc.)
        }
        failure {
            echo 'âŒ Pipeline fallÃ³!'
            echo 'âš ï¸ Revisa los logs y reportes para identificar el problema'
            // AquÃ­ podrÃ­as enviar notificaciones de fallo
        }
    }
}

